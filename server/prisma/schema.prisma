// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER MANAGEMENT
// ==========================================

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  name      String
  email     String   @unique
  password  String?
  department String?
  manager   String?
  isActive  Boolean  @default(true)
  isAdmin   Boolean  @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  registrationRequests RegistrationRequest[]
  approvals            RegistrationApproval[]
  groupMemberships     ApprovalGroupMember[]
  fieldChanges         FieldChangeHistory[]

  @@map("users")
}

// ==========================================
// APPROVAL GROUPS
// ==========================================

model ApprovalGroup {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     ApprovalGroupMember[]

  @@map("approval_groups")
}

model ApprovalGroupMember {
  id        String   @id @default(uuid())
  groupId   String
  userId    String
  addedAt   DateTime @default(now())
  addedById String?

  // Relations
  group     ApprovalGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("approval_group_members")
  @@index([groupId])
  @@index([userId])
}

// ==========================================
// FORM TEMPLATE MANAGEMENT
// ==========================================

model FormTemplate {
  id          String      @id @default(uuid())
  tableName   String?     @unique  // SB1, SA1, SA2 - Deprecated: use TemplateTable for multi-table
  label       String                // "Cadastro de Produtos"
  description String?
  isActive    Boolean     @default(true)
  metadata    Json?

  // Multi-table configuration
  isMultiTable Boolean    @default(false)  // true = uses TemplateTable, false = uses tableName

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  tables      TemplateTable[]       // Multiple tables (for multi-table templates)
  fields      FormField[]           // Fields (legacy for single-table or orphan fields)
  workflows   RegistrationWorkflow[]
  requests    RegistrationRequest[]

  @@map("form_templates")
}

// ==========================================
// TEMPLATE TABLES (Multi-Table Support)
// ==========================================

model TemplateTable {
  id              String       @id @default(uuid())
  templateId      String
  template        FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  tableName       String       // DA0, DA1, SA1, etc.
  alias           String       // "header", "items", "main" - unique identifier
  label           String       // "Cabeçalho", "Itens" - display name
  tableOrder      Int          // Order for display and processing

  // Relationship configuration
  relationType    String?      // 'parent' | 'child' | 'independent' | null
  parentTableId   String?      // ID of parent TemplateTable (when relationType = 'child')
  parentTable     TemplateTable? @relation("TableHierarchy", fields: [parentTableId], references: [id])
  childTables     TemplateTable[] @relation("TableHierarchy")
  foreignKeyConfig Json?       // { parentField: "DA0_CODTAB", childField: "DA1_CODTAB" }

  // Status
  isActive        Boolean      @default(true)
  metadata        Json?        // Additional configuration

  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  fields          FormField[]

  @@unique([templateId, tableName])
  @@unique([templateId, alias])
  @@map("template_tables")
  @@index([templateId])
  @@index([templateId, tableOrder])
}

model FormField {
  id              String       @id @default(uuid())
  templateId      String
  template        FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Multi-table support: link field to specific table
  tableId         String?      // Links to TemplateTable (for multi-table templates)
  table           TemplateTable? @relation(fields: [tableId], references: [id], onDelete: Cascade)

  // Field definition from SX3 (optional for custom fields)
  sx3FieldName    String?       // B1_COD, B1_DESC, etc (null for custom fields)
  fieldName       String?       // Unique field name (sx3FieldName or custom name) - temporarily nullable for migration
  label           String        // X3_TITULO or custom label
  fieldType       String        // string, number, date, boolean, select, textarea, checkbox, radio, autocomplete, multiselect, attachment, lookup
  isRequired      Boolean       // X3_OBRIGAT == 'S' or custom requirement
  isVisible       Boolean       // Admin configures this
  isEnabled       Boolean       @default(true)

  // Custom field indicator
  isCustomField   Boolean       @default(false)  // true = custom field, false = SX3 field
  isSyncField     Boolean       @default(true)   // true = sync to Protheus, false = local only

  // Multi-language labels from SX3
  labelPtBR       String?       // X3_TITULO (Portuguese)
  labelEn         String?       // X3_TITENG (English)
  labelEs         String?       // X3_TITSPA (Spanish)

  // Multi-language descriptions from SX3
  descriptionPtBR String?       // X3_DESCRIC (Portuguese)
  descriptionEn   String?       // X3_DESCENG (English)
  descriptionEs   String?       // X3_DESCSPA (Spanish)

  // Ordering and grouping
  fieldOrder      Int
  fieldGroup      String?       // "Dados Básicos", "Estoque", "Campos Customizados", etc

  // Data source configuration (for select, radio, autocomplete, multiselect)
  dataSourceType   String?      // 'fixed' | 'sql' | 'sx5'
  dataSourceConfig Json?        // { fixedOptions: [], sqlQuery: '', valueField: '', labelField: '', sx5Table: '' }

  // Lookup configuration (for lookup type)
  lookupConfig    Json?         // { sourceTable, searchFields, returnFields, valueField, displayField, modalConfig }

  // Additional configuration
  validationRules Json?         // { required, minLength, maxLength, regex, mask, sqlValidation, dependsOn }
  metadata        Json?         // { size, decimals, mask, lookup, options (for select) }
  placeholder     String?       // Placeholder text for input
  helpText        String?       // Help text shown below field

  // Attachment configuration (for attachment type)
  attachmentConfig Json?        // { allowedTypes: [], maxSize: number, maxFiles: number }

  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("form_fields")
  @@index([templateId])
  @@index([tableId])
  @@index([templateId, fieldOrder])  // For sorted field queries
  @@index([templateId, isVisible, isEnabled])  // For visible/enabled field queries
}

// ==========================================
// FIELD ATTACHMENTS
// ==========================================

model FieldAttachment {
  id             String    @id @default(uuid())
  registrationId String    // Links to RegistrationRequest.id
  fieldName      String    // Field name that this attachment belongs to

  // File information
  fileName       String    // Stored file name (hashed)
  originalName   String    // Original file name from upload
  mimeType       String    // MIME type (e.g., application/pdf)
  fileSize       Int       // File size in bytes
  filePath       String    // Full path to file on disk

  // Audit fields
  uploadedById   String    // User who uploaded
  uploadedAt     DateTime  @default(now())
  deletedAt      DateTime? // Soft delete timestamp

  @@map("field_attachments")
  @@index([registrationId, fieldName])
  @@index([uploadedById])
}

// ==========================================
// WORKFLOW CONFIGURATION
// ==========================================

model RegistrationWorkflow {
  id           String          @id @default(uuid())
  templateId   String
  template     FormTemplate    @relation(fields: [templateId], references: [id], onDelete: Cascade)

  name         String
  description  String?
  isActive     Boolean         @default(true)
  requiresSequentialApproval Boolean @default(true)
  routingRules Json?           // Conditional routing rules

  // Timestamps
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  levels       WorkflowLevel[]

  @@map("registration_workflows")
  @@index([templateId])
}

model WorkflowLevel {
  id          String                @id @default(uuid())
  workflowId  String
  workflow    RegistrationWorkflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  levelOrder  Int
  levelName   String?               // "Gerente", "Diretor", etc
  approverIds String[]              // Array of user IDs (individual approvers)
  approverGroupIds String[]         // Array of approval group IDs
  editableFields   String[]         // Fields that can be edited at this level
  isParallel  Boolean               @default(false)  // All must approve?
  conditions  Json?                 // Conditional rules (e.g., value > 10000)

  // Timestamps
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@map("workflow_levels")
  @@index([workflowId])
  @@unique([workflowId, levelOrder])
}

// ==========================================
// REGISTRATION REQUESTS
// ==========================================

enum RegistrationStatus {
  DRAFT
  PENDING_APPROVAL
  IN_APPROVAL
  APPROVED
  REJECTED
  RETURNED              // Sent back for revision (to requester or previous level)
  SYNCING_TO_PROTHEUS
  SYNCED
  SYNC_FAILED
}

model RegistrationRequest {
  id              String              @id @default(uuid())
  trackingNumber  String?             @unique  // Sequential tracking number (e.g., "2025-00001")
  templateId      String
  template        FormTemplate        @relation(fields: [templateId], references: [id])
  tableName       String              // Denormalized for quick access (primary table)

  // Requester info
  requestedById   String
  requestedBy     User                @relation(fields: [requestedById], references: [id])
  requestedByEmail String
  requestedAt     DateTime            @default(now())

  // Form data
  // For single-table: { fieldName: value, ... }
  // For multi-table: { tableAlias: { fieldName: value } | [{ fieldName: value }] }
  formData        Json                // All form field values

  // Multi-table metadata (for tracking sync results per table)
  // Structure: { tableAlias: { recno: "123", syncedAt: "..." }, items: [{ recno: "456" }, ...] }
  tableData       Json?               // Sync results and metadata per table

  // Operation type (NEW = new registration, ALTERATION = modify existing)
  operationType   String              @default("NEW")
  originalRecno   String?             // R_E_C_N_O_ of original record (for alterations)
  originalFormData Json?              // Original data from Protheus (for comparison)

  // Workflow status
  status          RegistrationStatus  @default(DRAFT)
  currentLevel    Int                 @default(1)
  workflowSnapshot Json?              // Snapshot of workflow at submission

  // Protheus integration
  protheusRecno   String?             // R_E_C_N_O_ from Protheus (primary table)
  syncedAt        DateTime?
  syncError       String?
  syncLog         Json?

  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  approvals       RegistrationApproval[]
  fieldChanges    FieldChangeHistory[]

  @@map("registration_requests")
  @@index([templateId])
  @@index([requestedById])
  @@index([status])
  @@index([createdAt])
}

enum ApprovalAction {
  PENDING
  APPROVED
  REJECTED
  SENT_BACK             // Returned to previous level or requester
}

model RegistrationApproval {
  id            String              @id @default(uuid())
  requestId     String
  request       RegistrationRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  level         Int
  approverId    String
  approver      User                @relation(fields: [approverId], references: [id])
  approverEmail String

  action        ApprovalAction      @default(PENDING)
  comments      String?
  actionAt      DateTime?

  // Timestamps
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@map("registration_approvals")
  @@index([requestId])
  @@index([approverId])
  @@index([level])
  @@unique([requestId, approverId, level])
}

// ==========================================
// FIELD CHANGE HISTORY (AUDIT TRAIL)
// ==========================================

model FieldChangeHistory {
  id            String              @id @default(uuid())
  requestId     String
  request       RegistrationRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  fieldName     String              // SX3 field name (e.g., B1_DESC)
  previousValue String?             // Value before change (JSON stringified for complex types)
  newValue      String?             // Value after change (JSON stringified for complex types)

  changedById   String
  changedBy     User                @relation(fields: [changedById], references: [id])
  changedAt     DateTime            @default(now())
  approvalLevel Int                 // Level at which the change was made

  @@map("field_change_history")
  @@index([requestId])
  @@index([changedById])
  @@index([fieldName])
}

// ==========================================
// SYSTEM SETTINGS (SEC-01: Secure Credentials Storage)
// ==========================================

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique  // "PROTHEUS_API_URL", "JWT_SECRET", etc
  value       String   // Encrypted value for secrets, plain for non-secrets
  description String?
  isSecret    Boolean  @default(false)  // If true, value is encrypted with AES-256
  category    String?  // "protheus", "auth", "email", "system", etc

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedById String?

  @@map("system_settings")
  @@index([category])
}

// ==========================================
// TRACKING SEQUENCE (for sequential tracking numbers)
// ==========================================

model TrackingSequence {
  id         String   @id @default(uuid())
  year       Int      @unique  // 2025
  lastNumber Int      @default(0)  // Last number used for this year
  updatedAt  DateTime @updatedAt

  @@map("tracking_sequences")
}

// ==========================================
// ALLOWED TABLES FOR LOOKUP QUERIES
// ==========================================

model AllowedLookupTable {
  id          String   @id @default(uuid())
  tableName   String   @unique  // SA1010, SYS_COMPANY, etc.
  description String?  // Clientes, Empresas/Filiais, etc.
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("allowed_lookup_tables")
}
