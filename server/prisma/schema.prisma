// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER MANAGEMENT
// ==========================================

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  name      String
  email     String   @unique
  password  String?
  department String?
  manager   String?
  isActive  Boolean  @default(true)
  isAdmin   Boolean  @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  registrationRequests RegistrationRequest[]
  approvals            RegistrationApproval[]
  groupMemberships     ApprovalGroupMember[]
  fieldChanges         FieldChangeHistory[]

  @@map("users")
}

// ==========================================
// APPROVAL GROUPS
// ==========================================

model ApprovalGroup {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     ApprovalGroupMember[]

  @@map("approval_groups")
}

model ApprovalGroupMember {
  id        String   @id @default(uuid())
  groupId   String
  userId    String
  addedAt   DateTime @default(now())
  addedById String?

  // Relations
  group     ApprovalGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("approval_group_members")
  @@index([groupId])
  @@index([userId])
}

// ==========================================
// FORM TEMPLATE MANAGEMENT
// ==========================================

model FormTemplate {
  id          String      @id @default(uuid())
  tableName   String      @unique  // SB1, SA1, SA2, DA0, DA1
  label       String                // "Cadastro de Produtos"
  description String?
  isActive    Boolean     @default(true)
  metadata    Json?

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  fields      FormField[]
  workflows   RegistrationWorkflow[]
  requests    RegistrationRequest[]

  @@map("form_templates")
}

model FormField {
  id              String       @id @default(uuid())
  templateId      String
  template        FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Field definition from SX3 (optional for custom fields)
  sx3FieldName    String?       // B1_COD, B1_DESC, etc (null for custom fields)
  fieldName       String?       // Unique field name (sx3FieldName or custom name) - temporarily nullable for migration
  label           String        // X3_TITULO or custom label
  fieldType       String        // string, number, date, boolean, select, textarea
  isRequired      Boolean       // X3_OBRIGAT == 'S' or custom requirement
  isVisible       Boolean       // Admin configures this
  isEnabled       Boolean       @default(true)

  // Custom field indicator
  isCustomField   Boolean       @default(false)  // true = custom field, false = SX3 field
  isSyncField     Boolean       @default(true)   // true = sync to Protheus, false = local only

  // Multi-language labels from SX3
  labelPtBR       String?       // X3_TITULO (Portuguese)
  labelEn         String?       // X3_TITENG (English)
  labelEs         String?       // X3_TITSPA (Spanish)

  // Multi-language descriptions from SX3
  descriptionPtBR String?       // X3_DESCRIC (Portuguese)
  descriptionEn   String?       // X3_DESCENG (English)
  descriptionEs   String?       // X3_DESCSPA (Spanish)

  // Ordering and grouping
  fieldOrder      Int
  fieldGroup      String?       // "Dados BÃ¡sicos", "Estoque", "Campos Customizados", etc

  // Additional configuration
  validationRules Json?         // Custom validation rules
  metadata        Json?         // { size, decimals, mask, lookup, options (for select) }
  placeholder     String?       // Placeholder text for input
  helpText        String?       // Help text shown below field

  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("form_fields")
  @@index([templateId])
}

// ==========================================
// WORKFLOW CONFIGURATION
// ==========================================

model RegistrationWorkflow {
  id           String          @id @default(uuid())
  templateId   String
  template     FormTemplate    @relation(fields: [templateId], references: [id], onDelete: Cascade)

  name         String
  description  String?
  isActive     Boolean         @default(true)
  requiresSequentialApproval Boolean @default(true)
  routingRules Json?           // Conditional routing rules

  // Timestamps
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  levels       WorkflowLevel[]

  @@map("registration_workflows")
  @@index([templateId])
}

model WorkflowLevel {
  id          String                @id @default(uuid())
  workflowId  String
  workflow    RegistrationWorkflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  levelOrder  Int
  levelName   String?               // "Gerente", "Diretor", etc
  approverIds String[]              // Array of user IDs (individual approvers)
  approverGroupIds String[]         // Array of approval group IDs
  editableFields   String[]         // Fields that can be edited at this level
  isParallel  Boolean               @default(false)  // All must approve?
  conditions  Json?                 // Conditional rules (e.g., value > 10000)

  // Timestamps
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@map("workflow_levels")
  @@index([workflowId])
  @@unique([workflowId, levelOrder])
}

// ==========================================
// REGISTRATION REQUESTS
// ==========================================

enum RegistrationStatus {
  DRAFT
  PENDING_APPROVAL
  IN_APPROVAL
  APPROVED
  REJECTED
  RETURNED              // Sent back for revision (to requester or previous level)
  SYNCING_TO_PROTHEUS
  SYNCED
  SYNC_FAILED
}

model RegistrationRequest {
  id              String              @id @default(uuid())
  templateId      String
  template        FormTemplate        @relation(fields: [templateId], references: [id])
  tableName       String              // Denormalized for quick access

  // Requester info
  requestedById   String
  requestedBy     User                @relation(fields: [requestedById], references: [id])
  requestedByEmail String
  requestedAt     DateTime            @default(now())

  // Form data
  formData        Json                // All form field values

  // Workflow status
  status          RegistrationStatus  @default(DRAFT)
  currentLevel    Int                 @default(1)
  workflowSnapshot Json?              // Snapshot of workflow at submission

  // Protheus integration
  protheusRecno   String?             // R_E_C_N_O_ from Protheus
  syncedAt        DateTime?
  syncError       String?
  syncLog         Json?

  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  approvals       RegistrationApproval[]
  fieldChanges    FieldChangeHistory[]

  @@map("registration_requests")
  @@index([templateId])
  @@index([requestedById])
  @@index([status])
  @@index([createdAt])
}

enum ApprovalAction {
  PENDING
  APPROVED
  REJECTED
  SENT_BACK             // Returned to previous level or requester
}

model RegistrationApproval {
  id            String              @id @default(uuid())
  requestId     String
  request       RegistrationRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  level         Int
  approverId    String
  approver      User                @relation(fields: [approverId], references: [id])
  approverEmail String

  action        ApprovalAction      @default(PENDING)
  comments      String?
  actionAt      DateTime?

  // Timestamps
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@map("registration_approvals")
  @@index([requestId])
  @@index([approverId])
  @@index([level])
  @@unique([requestId, approverId, level])
}

// ==========================================
// FIELD CHANGE HISTORY (AUDIT TRAIL)
// ==========================================

model FieldChangeHistory {
  id            String              @id @default(uuid())
  requestId     String
  request       RegistrationRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  fieldName     String              // SX3 field name (e.g., B1_DESC)
  previousValue String?             // Value before change (JSON stringified for complex types)
  newValue      String?             // Value after change (JSON stringified for complex types)

  changedById   String
  changedBy     User                @relation(fields: [changedById], references: [id])
  changedAt     DateTime            @default(now())
  approvalLevel Int                 // Level at which the change was made

  @@map("field_change_history")
  @@index([requestId])
  @@index([changedById])
  @@index([fieldName])
}

// ==========================================
// SYSTEM SETTINGS (SEC-01: Secure Credentials Storage)
// ==========================================

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique  // "PROTHEUS_API_URL", "JWT_SECRET", etc
  value       String   // Encrypted value for secrets, plain for non-secrets
  description String?
  isSecret    Boolean  @default(false)  // If true, value is encrypted with AES-256
  category    String?  // "protheus", "auth", "email", "system", etc

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedById String?

  @@map("system_settings")
  @@index([category])
}
